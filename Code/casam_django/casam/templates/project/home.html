
{% extends 'base.html' %}
{% block title %}Overzicht projecten en foto's{% endblock title %}

{% block head %}
  <link href="{{ BASE_PATH }}media/css/whiteFrame.css" rel="stylesheet" type="text/css" media="screen" />
  <link href="{{ BASE_PATH }}media/css/projectHome.css" rel="stylesheet" type="text/css" media="screen" />
	<script src="{{ BASE_PATH }}media/js/ajax.js" type="text/javascript"></script>
	<script src="{{ BASE_PATH }}media/js/getmouse.js" type="text/javascript"></script>
	<script src="{{ BASE_PATH }}media/js/images.js" type="text/javascript"></script>
	<script src="{{ BASE_PATH }}media/js/landmarks.js" type="text/javascript"></script>
  <script src="{{ BASE_PATH }}media/js/casamcustom.js" type="text/javascript"></script>
  <script type="text/javascript">
    var base_path = {{ BASE_PATH }}
    var total_images = 0;

	  document.observe("dom:loaded", function()
		{
      // Add tabs in whiteFrame
      $('leftFrame_content').insert(newTab('Project information', $('tab_projectinfo'), true));
      $('leftFrame_content').insert(newTab('Pictures', $('tab_pictures'), true));
      $('leftFrame_content').insert(newTab('Papers', $('tab_papers'), false));
      
      $('rightFrame_content').insert(newTab('Possible measurements', $('tab_measurements'), false));
      $('rightFrame_content').insert(newTab('Transparency', $('tab_attributes'), false));

		  // Add mouse listener for image
			document.observe('mousemove', getMouseXY);

			// Load images
			getProjectImages();

			// Load tags
			getProjectTags();
			
			// Make draggable's for each Measurement
			{% for mm in mmetings %}
				new Draggable('mm{{mm.id}}', { onEnd: function() {
						if($('MouseX').value != "" && $('MouseY').value != "") LoadMMDD('{{mm.id}}') 
					}
				});
			{% endfor %}
			new Draggable('lmdd');
			new Draggable('leftFrame', { handle: 'leftFrameHandle' });
			new Draggable('rightFrame', { handle: 'rightFrameHandle' });
			resizeScreenElements();
			Event.observe(window,'resize',function(){
				resizeScreenElements();
			});
			Event.observe('editTagsLink','click',function(){
				popupIFrame('{{ BASE_PATH }}tag/select/{{ id }}',350,150);
			});
		});

		function resizeScreenElements()
		{
			var remainingWidth = document.viewport.getWidth() - 500;
			$('big_images').setWidth(remainingWidth);

			var remainingHeight = document.viewport.getHeight() - 150;
			$('big_images').setHeight(remainingHeight);
			remainingHeightWhiteFrame = remainingHeight - 36; 
			$('leftFrame').setHeight(remainingHeightWhiteFrame);
			$('rightFrame').setHeight(remainingHeightWhiteFrame);
				
		}

		function toggleTab(tab)
		{
			Effect.toggle(tab, 'blind', { duration: 0.5 });
		}
	  
		function newTab(tab_title, content, open)
		{
			var tabContainer = new Element('div');
			var tabHeader = new Element('div');
			var tabLine = new Element('div');
			if (Object.isElement(content)) {
				content.parentNode.removeChild(content);
			  tabBody = content;
			} else {
				var tabBody = new Element('div');
				tabBody.id = content;
			}
			if (!open)
				tabBody.hide();

  	  tabHeader.style.backgroundColor = "#dddddd";
  	  tabHeader.style.cursor = "pointer";
			tabHeader.observe('click', function(){
				  toggleTab(tabBody);
				}
			);
			foldUpImage  = new Element('img');
			foldDownImage = new Element('img');
			foldUpImage.setAttribute( "src", "{{ BASE_PATH }}media/img/fold_up.gif");
			foldUpImage.setStyle("float:left;margin:2px;");
			foldDownImage.setAttribute( "src", "{{ BASE_PATH }}media/img/fold_down.gif");
		  foldDownImage.setStyle("float:right;margin:2px;");

		  tabHeader.insert(foldUpImage);
		  tabHeader.insert(foldDownImage);
			tabHeader.innerHTML += "<b>"+tab_title+"</b>";

			tabLine.style.height = "2px";
			tabLine.style.backgroundImage = "url('{{ BASE_PATH }}media/img/bar_middle.jpg')";
			tabLine.style.backgroundRepeat = "repeat-x";
			tabLine.innerHTML = "<img src=\"{{ BASE_PATH }}media/img/bar_left.jpg\" style=\"float:left;\" />"+
			                    "<img src=\"{{ BASE_PATH }}media/img/bar_right.jpg\" style=\"float:right;\" />";
			
			// Return the three div's
			tabContainer.insert(tabHeader);
			tabContainer.insert(tabLine);
			tabContainer.insert(tabBody);
			return tabContainer;
		}
	  
		function getProjectImages()
		{
			var url = '{{ BASE_PATH }}project/projectImagesJSON/{{id}}?time='+new Date().getTime();
			// notice the use of a proxy to circumvent the Same Origin Policy
			new Ajax.Request(url, {
			  method: 'get',
			  onSuccess: function(transport, json) {
				  
			    var json = transport.responseText.evalJSON();
			    
			    //$('pictureContainerHeader').update('Pictures('+json.length+')');
			     
			    $('tab_pictures').update();
			     
			    // Create a picture container for each picture
			    for(i=0; i < json.length; i++)
						makePictureContainer(json[i]);
					// Put bar in Pictures
					var toolbar = new Element('div');
					toolbar.setStyle("clear:both;float:right;");
					var addLink = new Element('a',{'href':'#'});

					var addImage = new Element('img',{'src':'{{ BASE_PATH }}media/img/add.jpg','id':'addPictureButton','class':'smallPictureButton'});
					addLink.insert(addImage);
					toolbar.insert(addLink);
					Event.observe(addLink,'click',function(){
						popupIFrame('{{BASE_PATH}}fileupload/{{ id }}',350,200);
					});
					//toolbar.innerHTML =  "<a href=\"../fileupload/{{ id }}\"><img border=\"0\" src=\"{{ BASE_PATH }}media/img/add.jpg\" /></a>";
					//toolbar.innerHTML += "<a href=\"../fileupload/{{ id }}\"><img border=\"0\" src=\"{{ BASE_PATH }}media/img/delete.jpg\" /></a>";
					//toolbar.innerHTML += "<a href=\"../fileupload/{{ id }}\"><img border=\"0\" src=\"{{ BASE_PATH }}media/img/camera.jpg\" /></a>";
					$('tab_pictures').insert(toolbar);
				}
			});
		}

		function getProjectTags()
		{
			var url = '{{ BASE_PATH }}project/projectTagsJSON/{{id}}?time='+new Date().getTime();
			// notice the use of a proxy to circumvent the Same Origin Policy
			new Ajax.Request(url, {
			  method: 'get',
			  onSuccess: function(transport, json) {
				  
			    var json = transport.responseText.evalJSON();
			    			     
			    $('tags').update();
			     
			    // Create a picture container for each picture
			    for(i=0; i < json.length; i++)
						$('tags').insert(new Element('p').update(json[i].fields.name));
				}
			});
		}

		
		function makePictureContainer(pictureJSON)
		{
			var mainDiv = new Element('div');
			     mainDiv.addClassName('projectPictureDiv');
			var leftDiv = new Element('div');
					 leftDiv.addClassName('pictureContainerLeftDiv');
			var rightDiv = new Element('div');
			    rightDiv.addClassName('pictureContainerRightDiv');
			
			leftDiv.insert(new Element('img',{'src': base_path+'imageLoader/thumbnail/50/'+pictureJSON.pk}));
			rightDiv.insert(new Element('span').update(pictureJSON.fields.name).addClassName('projectPictureInfo'));
			rightDiv.insert(new Element('span').update(pictureJSON.fields.added).addClassName('projectPictureInfo'));
			
			if(pictureJSON.fields.isLeft)
			  rightDiv.insert(new Element('span').update('Left').addClassName('projectPictureInfo'));
			else
			 rightDiv.insert(new Element('span').update('Right').addClassName('projectPictureInfo'));
			
			var useLink = new Element('a',{'href':'#'}).update('Use');
			rightDiv.insert(useLink);
			$('tab_pictures').insert(mainDiv);
			useLink.observe('click', function(){                                          
				 	show_image(base_path+'imageLoader/'+pictureJSON.pk);
				 	return false;
				}
			);
			mainDiv.insert(leftDiv);
			mainDiv.insert(rightDiv);
		}

		function closePopupAndReloadPictures(){
			getProjectImages();
			new Effect.Highlight('tab_pictures');
			//$('tab_pictures').scrollTo($('addPictureButton'));
			closePopup();	
		}

		function closePopupAndReloadTags(){
			getProjectTags();
			new Effect.Highlight('tags');
			closePopup();	
		}
  </script>

{% endblock head %}

{% block body %}
<div id="popup"></div>
<div id="leftFrame" class="whiteFrame_container" style="float:left;position:absolute;top:105px;left:5px;">

	<!-- Top white frame -->
	<div class="whiteFrame_top_container">
		<div class="whiteFrame_top_left"></div>
		<div id="leftFrameHandle" class="whiteFrame_top_middle" style="color:grey;text-align: center;line-height: 20px ;font-size: 8pt;">View</div>
		<div class="whiteFrame_top_right"></div>
	</div>

	<div class="whiteFrame_center_container">

		<!-- Left white frame -->
		<div class="whiteFrame_center_left"></div>

		<!-- Content white frame -->
		<div class="whiteFrame_center_middle">
		  <div id="leftFrame_content"></div>
		</div>

		<!-- Right white frame -->
		<div class="whiteFrame_center_right"></div>

	</div>

	<!-- Bottom white frame -->
	<div class="whiteFrame_bottom_container">
		<div class="whiteFrame_bottom_left"></div>
		<div class="whiteFrame_bottom_center"></div>
		<div class="whiteFrame_bottom_right"></div>
	</div>
</div>


<div id="rightFrame" class="whiteFrame_container" style="float:left;position:absolute;top:105px;right:5px;">

	<!-- Top white frame -->
	<div class="whiteFrame_top_container">
		<div class="whiteFrame_top_left"></div>
		<div id="rightFrameHandle" class="whiteFrame_top_middle" style="color:grey;text-align: center;line-height: 20px ;font-size: 8pt;">Edit</div>
		<div class="whiteFrame_top_right"></div>
	</div>

	<div class="whiteFrame_center_container">

		<!-- Left white frame -->
		<div class="whiteFrame_center_left"></div>

		<!-- Content white frame -->
		<div class="whiteFrame_center_middle">
		  <div id="rightFrame_content"></div>
		</div>

		<!-- Right white frame -->
		<div class="whiteFrame_center_right"></div>

	</div>

	<!-- Bottom white frame -->
	<div class="whiteFrame_bottom_container">
		<div class="whiteFrame_bottom_left"></div>
		<div class="whiteFrame_bottom_center"></div>
		<div class="whiteFrame_bottom_right"></div>
	</div>
</div>


<div id="big_images" style="margin:auto;width:700px;height:400px;border:dashed 1px yellow;"></div>


<!-- TABS -->

<div id="tab_projectinfo" class="tabContent">
  <b>{{ project }}</b><br>
	<p>{{ project.description }}</p>
	<b>Tags</b>
	<a href="#" id='editTagsLink' style="float:right;clear:both;"><img src="{{BASE_PATH}}media/img/pencil.jpg" style="border:0px;" /></a>
	<div id="tags">

	</div>
</div>
<div id="tab_pictures" class="tabContent"></div>
<div id="tab_papers" class="tabContent">
  {% include 'annotation/list.html' %}<br>
  <a href="{{ BASE_PATH }}annotation/new/{{ id }}" style="float:right;clear:both;" target="_blank"><img src="{{BASE_PATH}}media/img/add.jpg" style="border:0px;" /></a>
</div>
<div id="tab_measurements" class="tabContent">
  <a href="{{ BASE_PATH }}pm/new/{{ id }}" style="float:right;clear:both;" target="_blank"><img src="{{BASE_PATH}}media/img/add.jpg" style="border:0px;" /></a>

	{%for mm in mmetings%}
		<div><img id="mm{{mm.id}}" 
							style="cursor: pointer; z-index: 5;" 
							src="{{BASE_PATH}}media/img/pin_red.gif" alt="pin" 
							onMouseOver="showLandmarkTooltip('{{mm.id}}');" 
						  onMouseOut="hideLandmarkTooltip('{{mm.id}}');" />{{mm.name}}</div>
	{% endfor %}

	{%for pt in punten %}
		<div>({{pt.x}},{{pt.y}}) in {{pt.mogelijkemeting.name}}</div>
	{% endfor %}

  {%for mm in mmetings%}
    <div id="tooltip{{mm.id}}" style="display:none;position: absolute; z-index: 5;">{{mm.name}}</div>
  {% endfor %}
	
</div>
<div id="tab_attributes" class="tabContent">
	<table style="width:200px">
		<tr><th>Set Transparancy:</th></tr>
		<tr><td colspan="2" id="sliders"></td></tr>
		<tr><th>Reset Images</th></tr>
		<tr><td id="delete_images"></td></tr>
		<tr><th>Coordinates</th></tr>
		<tr><td><input type="text" id="MouseX" value="0" size="4"> X<br />
		<input type="text" id="MouseY" value="0" size="4"> Y</td></tr>
		<tr><th>Results</th></tr>
		<tr><td id="ajax_result"></td></tr>
	</table>
</div>


<!-- POPUP -->
  
<div id="lmdd" style="display: none; position: absolute; background-color: white; color: black; padding: 5px;">
	<div style="background-color: #ccc;">Store Landmark</div>
	<label for="mmx">x: </label><input type="text" style="width: 25px;" id="lmmx" name="mmx" value="" />
	<label for="mmy">y: </label><input type="text" style="width: 25px;" id="lmmy" name="mmy" value="" /><br />
	<label id="labelmmmeting" for="mmmeting">Landmark: </label><select id="mmmeting" name="mmmeting">
	<option value=""></option>
		{%for mm in mmetings%}
			<option id="option{{mm.id}}" value="{{mm.id}}">{{mm.name}}</option>
		{% endfor %}
	</select><br />
	<button onClick="saveLandMark();">Store</button>
</div>

{% endblock body %}
